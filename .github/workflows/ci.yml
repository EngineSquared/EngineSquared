name: ci

on:
  push:
    branches-ignore:
      - 'ga-ignore-**'
      - 'gh-pages'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  UNWANTED_REGEX: '^(?!.*tests\/).*gc(no|da|ov)$|(.*\.(a|o|so|lib))$|(.*~)$|^(#.*#)$|^tmp\/.*|.*\/tmp\/.*'

jobs:
  check_repository_cleanliness:
    name: Checks if the repository is clean and void of any unwanted files (temp files, binary files, etc.)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find unwanted files
        run: |
          UNWANTED_FILES=$(find . -type f -printf '%P\n' | grep -P "${{ env.UNWANTED_REGEX }}" || true)
          if [ -n "$UNWANTED_FILES" ]; then
            while IFS= read -r LINE; do
              echo "::error file=${LINE},line=1,col=1,title=Unwanted file detected::${LINE}"
            done <<< "$UNWANTED_FILES"
            echo "FAIL_TASK=true" >> "$GITHUB_ENV"
            exit 1
          else
            echo "FAIL_TASK=false" >> "$GITHUB_ENV"
          fi

  lint_code:
    name: Lint with clang-format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_CI_TEST }}

      - name: Install clang-format
        run: sudo apt-get install -y clang-format

      - name: Run clang-format
        run: |
          git ls-files -z "*.cpp" "*.hpp" "*.inl" | while IFS= read -rd '' f; do tail -c1 < "$f" | read -r _ || echo >> "$f"; done
          find . -iname '*.hpp' -o -iname '*.cpp' -o -iname '*.inl' | xargs clang-format -i

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Push changes
        run: |
          git add .
          git commit -m "style: apply linter" || true
          git push || true

  check_program_compilation:
    name: Build and verify binaries
    needs: [check_repository_cleanliness, lint_code]
    strategy:
      matrix:
        include:
          - os: windows-latest
          - os: ubuntu-latest
          - os: macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Setup Linux dependencies
        if: contains(runner.os, 'linux')
        run: |
          sudo apt-get update
          sudo apt-get install -y libglu1-mesa-dev freeglut3-dev mesa-common-dev mesa-utils

      - name: Setup Windows dependencies
        if: contains(runner.os, 'windows')
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@e50494030a33fd120900e739f6418a48100cd6ce
        with:
          xmake-version: latest
          actions-cache-folder: '.xmake-cache'
          actions-cache-key: '${{ runner.os }}-xmake-install'
          package-cache: true
          package-cache-key: '${{ runner.os }}-xmake-packages'
          project-path: '.'
          build-cache: true
          build-cache-key: '${{ runner.os }}-xmake-build'

      - name: Build project
        run: xmake build -y
        timeout-minutes: 120

  check_examples:
    name: Build and test examples
    if: startsWith(github.event.head_commit.message, 'example')
    needs: [check_repository_cleanliness, lint_code]
    strategy:
      matrix:
        include:
          - os: windows-latest
          - os: ubuntu-latest
          - os: macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Linux dependencies
        if: contains(runner.os, 'linux')
        run: |
          sudo apt-get update
          sudo apt-get install -y libglu1-mesa-dev freeglut3-dev mesa-common-dev mesa-utils

      - name: Setup Windows dependencies
        if: contains(runner.os, 'windows')
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@e50494030a33fd120900e739f6418a48100cd6ce
        with:
          xmake-version: latest
          actions-cache-folder: '.xmake-cache'
          actions-cache-key: '${{ runner.os }}-xmake-examples'
          package-cache: true
          package-cache-key: '${{ runner.os }}-xmake-entt-vulkan-glm'
          project-path: '.'

      - name: Build and test examples (Linux/macOS)
        if: "!contains(runner.os, 'windows')"
        run: |
          for example_dir in ./examples/*/; do
            if [ -d "$example_dir" ]; then
              echo "Building example in $example_dir"
              cd "$example_dir"
              xmake build -y -P .
              if [ -f ".ci_run_target" ]; then
                echo "Running example in $example_dir"
                target=$(cat .ci_run_target)
                xmake run -P . $target
              fi
              cd - > /dev/null
            fi
          done
        timeout-minutes: 120

      - name: Build and test examples (Windows)
        if: contains(runner.os, 'windows')
        shell: pwsh
        run: |
          Get-ChildItem -Path "./examples" -Directory | ForEach-Object {
            $exampleDir = $_.FullName
            Write-Host "Building example in $exampleDir"
            Push-Location $exampleDir
            try {
              xmake build -y -P .
              if (Test-Path ".ci_run_target") {
                Write-Host "Running example in $exampleDir"
                $target = Get-Content ".ci_run_target" -Raw
                $target = $target.Trim()
                xmake run -P . $target
              }
            } finally {
              Pop-Location
            }
          }
        timeout-minutes: 120

  run_tests:
    name: Run tests
    needs: [check_repository_cleanliness, lint_code]
    strategy:
      matrix:
        include:
          - os: windows-latest
          - os: ubuntu-latest
          - os: macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Setup Linux test dependencies
        if: contains(runner.os, 'linux')
        run: |
          sudo apt-get update
          sudo apt-get install -y libglu1-mesa-dev freeglut3-dev mesa-common-dev mesa-utils
          sudo apt-get install -y python3 python3-pip
          pip3 install gcovr

      - name: Setup Windows dependencies
        if: contains(runner.os, 'windows')
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@e50494030a33fd120900e739f6418a48100cd6ce
        with:
          xmake-version: latest
          actions-cache-folder: '.xmake-cache'
          actions-cache-key: '${{ runner.os }}-xmake-install'
          package-cache: true
          package-cache-key: '${{ runner.os }}-xmake-entt-vulkan-glm'
          project-path: '.'

      - name: Run tests (Linux)
        if: contains(runner.os, 'linux')
        run: |
          xmake test -y -D
        timeout-minutes: 120

      - name: Run tests (Windows)
        if: contains(runner.os, 'windows')
        shell: pwsh
        run: |
          xmake test -y -D
        timeout-minutes: 120

      - name: Run tests (macOS)
        if: contains(runner.os, 'macos')
        run: |
          xmake test -y -D
        timeout-minutes: 120

      - name: Check test coverage (Linux)
        if: contains(runner.os, 'linux')
        uses: threeal/gcovr-action@64cb417ed6f143cafe1c69611922672002f460bb
